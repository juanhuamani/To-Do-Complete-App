name: Add Root User to EKS Cluster Only

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

jobs:
  add-user:
    name: Add Root User to Cluster
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Get cluster name
        id: get_cluster
        run: |
          # Usar el nombre del cluster directamente
          echo "cluster_name=todo-cluster-1b2c4b1" >> $GITHUB_OUTPUT
          echo "cluster=todo-cluster-1b2c4b1" >> $GITHUB_OUTPUT

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region "${{ env.AWS_REGION }}" --name "${{ steps.get_cluster.outputs.cluster_name }}"

      - name: Configure aws-auth ConfigMap (add root user for local access)
        shell: bash
        run: |
          set -euo pipefail
          
          ROOT_USER_ARN="arn:aws:iam::895416262297:root"
          echo "=========================================="
          echo "Configuring access for: $ROOT_USER_ARN"
          echo "=========================================="
          echo ""
          
          # Verificar el estado actual
          echo "=== Current ConfigMap state (if exists) ==="
          kubectl get configmap aws-auth -n kube-system -o yaml 2>/dev/null || echo "ConfigMap does not exist yet"
          echo ""
          
          # Obtener mapRoles existente (si existe) para preservarlo
          echo "=== Extracting existing mapRoles ==="
          if kubectl get configmap aws-auth -n kube-system -o json > /tmp/existing-auth.json 2>/dev/null; then
            MAP_ROLES=$(jq -r '.data.mapRoles // ""' /tmp/existing-auth.json)
            echo "Found existing mapRoles:"
            echo "$MAP_ROLES"
          else
            MAP_ROLES=""
            echo "No existing ConfigMap found"
          fi
          echo ""
          
          # Crear el ConfigMap completo usando jq para evitar problemas con heredoc en YAML
          echo "=== Creating new ConfigMap ==="
          if [ -n "$MAP_ROLES" ]; then
            # Si hay mapRoles existentes, preservarlos
            jq -n \
              --arg mapRoles "$MAP_ROLES" \
              '{
                "apiVersion": "v1",
                "kind": "ConfigMap",
                "metadata": {
                  "name": "aws-auth",
                  "namespace": "kube-system"
                },
                "data": {
                  "mapRoles": $mapRoles,
                  "mapUsers": "- userarn: arn:aws:iam::895416262297:root\n      username: root\n      groups:\n        - system:masters\n"
                }
              }' > /tmp/aws-auth.json
            # Convertir JSON a YAML
            kubectl create configmap aws-auth --from-file=/tmp/aws-auth.json --dry-run=client -o yaml | \
              sed 's/aws-auth.json/data/' | \
              jq -r '.data.data' | \
              jq -r '.data | to_entries[] | "\(.key): |\n\(.value | split("\n") | map("  \(.)") | join("\n"))"' > /tmp/aws-auth.yaml || {
              # Fallback: crear manualmente
              printf 'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: aws-auth\n  namespace: kube-system\ndata:\n  mapRoles: |\n%s\n  mapUsers: |\n    - userarn: arn:aws:iam::895416262297:root\n      username: root\n      groups:\n        - system:masters\n' "$(echo "$MAP_ROLES" | sed 's/^/    /')" > /tmp/aws-auth.yaml
            }
          else
            # Si no hay mapRoles, solo crear mapUsers
            printf 'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: aws-auth\n  namespace: kube-system\ndata:\n  mapUsers: |\n    - userarn: arn:aws:iam::895416262297:root\n      username: root\n      groups:\n        - system:masters\n' > /tmp/aws-auth.yaml
          fi
          
          echo "ConfigMap to apply:"
          cat /tmp/aws-auth.yaml
          echo ""
          
          # Aplicar el ConfigMap
          echo "=== Applying ConfigMap ==="
          if kubectl apply -f /tmp/aws-auth.yaml; then
            echo "✓ ConfigMap applied successfully"
          else
            echo "✗ Failed to apply ConfigMap"
            exit 1
          fi
          echo ""
          
          # Esperar a que se propague
          echo "=== Waiting for changes to propagate ==="
          sleep 5
          echo ""
          
          # Verificar el resultado final
          echo "=== Final ConfigMap state ==="
          kubectl get configmap aws-auth -n kube-system -o yaml
          echo ""
          
          # Verificación final
          echo "=== Verification ==="
          if kubectl get configmap aws-auth -n kube-system -o yaml | grep -q "895416262297:root"; then
            echo "✓✓✓ SUCCESS: Root user is configured in aws-auth ConfigMap!"
          else
            echo "✗✗✗ ERROR: Root user NOT found in ConfigMap!"
            exit 1
          fi

      - name: Verify cluster access
        run: |
          echo "=========================================="
          echo "Verifying cluster access..."
          echo "=========================================="
          echo ""
          
          echo "=== Cluster nodes ==="
          kubectl get nodes || echo "⚠ Could not get nodes"
          echo ""
          
          echo "=== Namespaces ==="
          kubectl get namespaces || echo "⚠ Could not get namespaces"
          echo ""
          
          echo "=== Pods in todo namespace ==="
          kubectl get pods -n todo 2>/dev/null || echo "⚠ Namespace 'todo' may not exist yet"
          echo ""
          
          echo "✓ Workflow completed successfully!"
          echo "You can now run 'kubectl' commands from your local machine."